## SignVerifier
SignVerifier is a simple AES-based sign checker implemented with Java & JNI (JAVA Native Interface) library.  
Challenge is designed on openjdk-14.0.2, so all code & explanation below are based on certain version.

## Vulnerability

There are one clear vulnerability on JNI side function `Java_SignVerifier_decode`  
- No length check in base64 decode routine.

This leads buffer overflow on byte array `sign`, which is member of object `SignVerifier` and located in Java heap area.  

## Exploit (stage 1)
Java object has following internal structure. (see [https://hg.openjdk.java.net/jdk/jdk14/file/6c954123ee8d/src/hotspot/share/oops/arrayOop.hpp#l37])
```
// The layout of array Oops is:
//
//  markWord
//  Klass*    // 32 bits if compressed but declared 64 in LP64.
//  length    // shares klass memory or allocated after declared fields.
class arrayOopDesc : public oopDesc {
  ...
}
```
We can overwrite metadata of `verify`, the second byte array member of `SignVerifier` object.  
By forgering `verify`'s length, we can leak heap memory behind `verify` at the end of the execution.  
```
System.out.println(new String(sv.getVerify()));
```
Since signature verify key is loaded in `key`, the third byte array member of `SignVerifier`, We can get it inside leaked heap memory.  

## Exploit (stage 2)
Klass pointer of Java object works like vtable of C++, it contains info about classes/method.  
However, by CDS(Client Data Sharing) of openjdk, Klass pointers are compressed (into int size) and always constant.  
Solver can parse and search the given CDS library(internal structure are defined in [https://hg.openjdk.java.net/jdk/jdk14/file/6c954123ee8d/src/hotspot/share/include/cds.h#l42] and [https://hg.openjdk.java.net/jdk/jdk14/file/6c954123ee8d/src/hotspot/share/memory/filemap.hpp#l173]), or dump the heap in local to get each classes's klass pointer.  
Note that `exec` method of `ResultGenerator` and `KeyLoader` has same method name & signature.
```
class KeyLoader{
  public String exec(String path, boolean isDebug){
    ...
```
```
class ResultGenerator{
  public String exec(String data, boolean isVerified){
    ...
```
So we can overwrite `ResultGenerator` object's klass pointer with `KeyLoader`'s and leads class confusion to read arbitrary (16-byte path length) file.


